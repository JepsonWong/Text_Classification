���ѧ��
JOURNAL OF SOFTWARE
2000��Vol.11��No.4��P.520-525




���������������������ʵ��
��ӱ�����Ρ�����
��ժҪ������SCSI(small computer system interface)���������Զ���������Ŀ����Ϊ�˸�Ч�ؿ���������������.�������������Զ����SCSI��ϵͳ�Ĵ���ά��,�Զ���������������󲿷ֵ�ģ��,�����Զ����,�ṩ���̡������������з�ʽ�µ���������.���Ľ������Զ������������˼�롢ϵͳ�������̼��������̡�ϵͳģ�鼰��νṹ���ӿں����д����Լ���������ʵ��,����ģ������Զ������ģ������.
���ؼ��ʡ��Զ�������,����ά��,ģ������.
����ͼ������š�TP319
Design and Implementation of a Driver Generator
WANG Ying��JIN Tao��SUN Yu-fang
��Institute of Software��The Chinese Academy of Sciences��Beijing��100080��
Abstract����An SCSI (small computer system interface) driver automatic generator has been developed for developing SCSI drivers efficiently. The generator can automatically maintain SCSI subsystem code, generate most driver modules, package, and provide drivers under the master and slave running modes. In this paper, the authors present the automatic generator's design method, system control flow, data flow, system modules and hierarchy, interface and running processing. The paper describes in brief the system implementation, including the module management, automatic packaging, and model generation.
Key words��Automatic generator, code maintainable, model generation.
������80���������,SCSI(small computer system interface,С�ͼ����ϵͳ�ӿ�)��1�ݲ�Ʒ��Ϊ��Ч�Ĵ�ȡ�ֶα��㷺�����ڸ��ּ����.COSIX��Ϊ��������UNIX����ϵͳ��2������İ汾��֧�ֵ����俨�����١�Ч�ʵ�,�����ѻ�����ʱ.��������賧������������������Ʒ,ֻ���ṩ�����豸���������򣻲���ϵͳ����ֻ����������������ĳ���ļ��ɹ���,���Ƕ����ؿ��������������������.�����ڹ�������ϵͳ,Ϊ����Ӧ����������Ӳ�����ͱ������û��ṩ��Ч����������,�������Զ����������ɸ�����������,�����������;��.��Ȼ,�������������������Ķ�估Ӳ��������,���������Զ��������Ѷȼ���.
�����������龭��������ļ��Ŭ��Բ�����������һ����,����ʵ�������ʹ�õ�֪,�Զ����ɵ�COSIX V1.1 SCSI��������ӽ���UNIX SVR 4.0ϵͳ��������������,��I/O������Ч�ʺ�ռ�ú��Ŀռ��С���봫ͳ���������൱.������һ�������ɴ���ȼ�СSCSI�豸�������򿪷��ĸ�����,������������,���ɵõ���ȷ���ҿ��ŶȺܸߵĴ���.���ĵ�1�ڽ����������������������.��2�ڽ���ϵͳ��ʵ��.��3��С��.
1 ϵͳ���
1.1��ϵͳ��˼
����SCSI���������������������ʵ�ֱ�Ȼǣ�浽SCSI����������Ľṹ���.Ϊ�˱����������Ŀ���,��������ΪSCSI������ϵͳ����������Ĳ�νṹ,��ʹ�����ݽṹ�Ϳ���������������Ӧ��ͬ�����俨.
�������ǿ�������೧���ṩ��SCSI��ϵͳ,���е��˽⵽�������������ṩ��SCSIϵͳ�ṹ��ͬ,����ͬһ���ҵ�SCSIϵͳҲ������ͬ,����ϵͳ�ڲ��ṹ������.��һ�����о�����,��Ȼ��ͬ���̵�SCSI���俨��Ӳ����ͬ,��Ӳ���Ľӿڲ���ܴ�,�������ڽϸ߲��߼����н��ƵĲ�������,�Ͼ�������ѭ��ͬ��SCSI�淶.Ϊ��,�ڽ�������������ṹ���ʱ,��SCSI���������ڽṹ�Ͻ��л���,�Ѳ�ͬ���俨�Ĺ�����������,�����߼�����Զ����Ĺ���ģ��,������ͬ���俨�Ĳ����װ�ڸ��Բ�ͬ��ģ����,�߲�ͨ����ͬ�ĺ����ӿ�����.������˵,���ǰ��������ֳ��������󲿷֣�
����(1) SCSI�������򹫹�ģ��
������ PCI(������ƽӿ�)��3���豸֧�ֺ�����.PCI������΢�����������߽ṹ.COSIX���������������д����������ӦPCI������Լ����ض��Ĺ���,��ˣ��ṩ֧�ֲ�ͬPCI�豸�ĵײ㺯����Ϊ������ϵͳ������չ�����˻���.��ģ����ΪSCSI��������Ŀ�ѡģ��,����֧��PCI�����ϵ�SCSI���俨.
������ SCSIĿ���豸ģ��.��ģ�����������ģ��,��ͬ��ģ����Դ��̡��Ŵ��Ȳ�ͬ����豸.�Դ���Ŀ���豸ģ��Ϊ��,�������˲�ͬ��������ͬ����SCSIӲ�̵Ĳ���,��߲��ṩ�߼��������������Ĵ��̿ռ�.
������ SDI�ӿڼ����俨��������ģ��.COSIX SDI(SCSI��������ӿ�)��UNIX SVR4.0��4��SDI�ĳ���,��������Ͻ��������������.���俨��������ģ����Ϊ��ͬ���俨��������ĳ���͹������ֶ�����һ��ģ��,��SCSI���俨�����������.
����(2) SCSI���俨�ӿں�����
�����˺�����ĵ�λ������SDI,ֻ�������������Ŀ���豸,����������俨�豸������Ƶ�.���ڲ�ͬSCSI���俨,�˺�����ӿ�Ӧ�����ż���.Ҳ����˵���˺��������ά�����߼����ݽṹ��Ŀ��С,����������Ϊ��.�ⲿ���벻ͬ��Ӳ���ṹ�������,�����ֹ���Ԥ,��ʵ�����������,��ʹ����SCSI����ģ��Ч�����.
����(3) SCSI�����������ɼ�ά������
�����ھ߱�������(1)��(2)�Ļ�����,������Ӧ�ܹ����� �Զ�����Ŀ¼�ṹ,Ѱ���������ӿ�ģ�飬��������޶ȵؼ��ģ���ڲ��ĺϷ��ԣ��� �Զ�����SCSI��������ϵͳ����,�Ա�ϵͳ����Ա���������ã��� ����ϵͳ����Ա����,���ɲ�ͬ�Ĵ���ļ�,���������ϵͳ��װ�̣��� �����������ϵͳ�йص�����,�����õ��û�����,��ǿ���ݴ�����.
�������ڲ�ͬ�����俨Ӳ������ܴ�,ͬʱ�ܵ�����Ӳ��������չ��Լ��,SCSI���俨�ӿں���������Ż���ƺ���100���ص���ʵ��,�����ʱ�����Ǹ������Ҫ��,��ʵ��ĳ��ƽ��.
�����ڴ˻�����,�γ���������������������,����һ�����������������ƹ���,��ͼ1��ʾ.

��SCSI����������,�����е�SCSI��ͬ�ͺ�������������,��������SCSI����������,���Զ����������,���˹���Ԥ,��SCSI��������.
Fig.1 Generator architecture
ͼ1���������ṹ
������ͼ1�У�SCSI����������(1)�ڰ���SCSI�������򹫹�ģ�¿�.�����е�SCSI��ͬ�ͺ��������йغ�����(2)����Ҫ����SCSI���俨�ӿں������ⲿ�ֺ�������ֲ�ͬ��Ӳ���ṹ������أ���ȴ��һ����������ģ��.����(2)��û�ж�������SCSI��������ֻ���ṩ��ص�����������(3).�ڱ�Ҫ���˹���Ԥ(5)��ͨ���Զ��������(4)�������������SCSI��������(6),��Ȼ�����ɵ�SCSI���������辭�����Դ���ȹ��̲����������.
������ͼ1��,��������Makefile,Shell�����Ӧ�ó������,����Աͨ��һ�ֽ�����������й������������ɾ��󲿷ֲ���.ϵͳ��ÿһ�����ǽ��������µ��ӹ���,ͬʱ����һ���ܶ�����ɹ̶����ܵ�ģ��.
1.2��ϵͳ��������
����������ϵͳ�Ŀ���������ͼ2��ʾ,ͼ�е���Щ��ģ������������ĸ����.

�ٳ�ʼ��,������������̨,��ģ�����,�ܺ�������,�ݲ���,�޴������,����������,���,ģ��,����,ɾ��,���ݵ�,�����������ϡ����أ������������ܲ��ԣ����������ɰ�װ�̣�ϵͳ���ã�����.
Fig.2 System flow
ͼ2��ϵͳ����
1.3����������
���������������ܵĻ����ϣ����ݳ���Ա���������Ĳ����������������Ӧ�Ĺ���.��ˣ�������������Դ��Ҫ�������������ܡ������������صĸ��������Լ�����Ա������ѡ�񣬾������������ģ�飬�����������ͼ3��ʾ.

��Makefile��Shell����,��ϵͳ���ü���Դ˵���ļ�,�۳���Աѡ������,�����������ܼ����ݽṹ,���±����俨��������,�޲�������,�߽�������̨,��������ģ��,��ģ��˵���ṹ,��ģ�����ģ��,�������ýṹ,��������ģ��,����ģ��,�����,����/��Ϣ,�����Ӱ�װ�̣������������������俨����⣬�����ļ����º��ģ����Ա���
Fig.3 Data flow
ͼ3����������
1.4��ϵͳ��ϵ�ṹ
1.4.1 ϵͳ���
���������������Ԫ����Ҫ������������̨(CONSOLE)��ģ�����(MODMAN)����������(KERGEN)������(TEST)���������(PACKAGE)������������(SDF)�����������Ϣ(KRI)������(KERNEL).������һ����.
������������̨��Ϊ����Ա�ṩ���������������ɵĽ�������.����Ա����ͨ���˵�ѡ��ʵ�־���Ĳ��������ã�ͬʱ,����̨�����Ա��ʾ�����ӹ���ģ���ִ������ͳ�����Ϣ.��ģ�齫ͨ���źź͹ܵ�����ӹ��ܽ���ͨ��,�Ӷ������ӹ���ģ���ִ��.
ģ�����������SCSI��������ģ����й���.����Ա����ͨ����ģ�����ӡ�ɾ����������SCSIģ��,�������ӵ����俨����ģ���ṩ����ָ��.
�����������ɼ����ԣ��Ե�ǰϵͳ����SCSI���ֽ�������.����Ա����ͨ����ģ�����ӡ�ɾ�������ĸ�SCSIģ��,����������Ĳ���,������ʱ����������̨,��������Ա������ҵ������.��ģ�齫ͨ���źź͹ܵ��븸����ͨ��,�Ӷ�����ģ��ִ�е����.
�������ԣ������Ա�ṩ����SCSI��������Ľ���,��ʾ��������ִ�е����.���ڲ��ܱ�֤����Ա�ṩ�����������ȷ��,�����п������ϵͳ���������غ��.��ģ����������������̺����˻���SCSI�豸���Եĸ�������.��ģ�齫ͨ���źź͹ܵ��븸����ͨ��,�Ӷ�����ģ��ִ�е����.
������ߣ�������Ա��Ҫ����������������Ĺ���.��ģ��ʹ�õ�makefile,shell�ű���ԭ����UNIXϵͳ�ļ����ԣ�������ף�5,6��.����SCSI�豸��Ҫ����Ϊϵͳ��(������ϵͳ���İ�װ������Ļ����洢�豸),�ֿ�����Ϊ�����Ĵ洢��,����Ҫ�ֱ������(ǰ��)�ʹ���(����)����ͬ�Ĵ���ʹ��.
�����������̿⣺��ģ�������ģ��Ľӿڽ��������ڳ�����ֲ�ķ�ʽ����.Ҳ����˵������Ա���˽ӿڱ��ƵĲ������̿��Է���ؼ������ģ����.
1.4.2 ϵͳ��νṹ
������������Ԫ�صĲ�νṹ��ͼ4��ʾ.����Աͨ������̨ʹ���������ĸ�����ģ�飬����SDF��KRI���õ����Ĳ������������Ӧ�Ĺ���.����������ģ�������̨����ִ������ͳ�����Ϣ.

Fig.4 Systemhierarchy
ͼ4��ϵͳ��νṹ
1.5���ӿ����
1.5.1 �û��ӿ�
�������������ṩ�û�����ʽ���棬�Ա�ʹ��������.��������ɲ˵�������,��˵��ṹ��ͼ5��ʾ.

Fig.5 Menu structure
ͼ5���˵��ṹ
1.5.2 �ⲿ�ӿ�
���������������ô�������ϵͳ����,����������ⲿ�ӿ��ϸ�����COSIX��ͬ�汾֧������Ľӿڶ���.
1.5.3 �ڲ��ӿ�
�������������ӹ���ģ����Ȼ�໥Ӱ��,��������֮��û��ֱ�ӵĽӿ�.���������̨ͨ���ź�(signal)���ܵ�(pipe)���ݿ�������Ϣ.���ӹ���ģ��ȿ��ڿ���̨֮������̨����,�ֿɶ���������������ʽ��������.
1.6���������
1.6.1 ϵͳ��ʼ��
������������ʼ��ʱ�ȼ������ĺϷ���,���Ƿ�ʧ�˱�Ҫ���ļ���Ȼ������Ŀ¼�������SCSIģ��,�����ڲ����ݽṹ������������ĵ��������,���ӹ���ģ��ʹ��.
1.6.2 ���п���
������������������������ģʽ�£�(1) �Խ����������ʽ������Աʹ�ã�(2) �ӹ���ģ���������,����ʽ���ӹ���ģ����������л���������.
���������Ժ�����ʽʹ��,ִ�еĽ������ͬ��.�ӹ���ģ�������ܹ��ֱ������ں���ģʽ��,���ݴ˾����������Ĳ�ͬ����.�������ĸ��ӹ���ģ���ǻ����,����һ���ӹ���ģ��ִ��ʱ,����������һ���ӹ���ģ������,�Ӷ���֤�й�SCSI�ĸ���ģ���һ����,Ҳ��֤���еİ�ȫ��.
1.7��ϵͳ������
����ϵͳ������3�������
���������ɻָ��Ĵ���,������.����������������Ĵ���,���������¼����SCSIģ��Ĵ����µ�,�������������ⲿ�ֲ����п�������,���Բ��������Ա�ṩ������Ϣ������ԭ��.
���������ش���,�������ļ���ʧ��.�����������,ϵͳ������һ���������Ա�ṩ����ԭ��,��һ���澡���ܵشӴ����лָ�,���������Ա���봦��.
������������Ϣ.ϵͳ��������ֹ����������,��ֻ�������Ա����һЩ��Ϣ.
2 SCSI������������������ʵ��
�����������Ǳ��ŷ������Ա��дSCSI������������Ͷ������ʵ�Ŀ�Ķ���Ƶ�.������ģ������Զ�������Զ��������俨ģ�弰���ָ�ϵ��ĵ�,�ύ������Ա�Ľ���һ������ı�̻���.���������ص���Բ���.
2.1��SCSI���������ģ�����
����SCSI���������Լ������ֳ����ɲ���,��������ģ����໥������ϵҲ��Ϊ����.��������ģ��������ϸ���ѭCOSIX���汾SCSI��������ṹ��Ƶ�,�ڴ˻����ϣ�����Щ�ļ�����.����ģ������������ SDI����ģ��(MOD��SCSI),ֻ��һ��ģ�飻�� SCSI�豸��������ģ��(MOD��STD),�������ɶ�����ģ�飻�� SCSI���俨��������ģ��(MOD��SAD),�������ɶ�����ģ�飻�� SCSI��������֧��ģ��(MOD��SUPPORT),����SCSI���������������ȫ����֧��ģ��,��PCIģ�飻�� SCSI�豸Ӧ�ó���ģ��(MOD��COMMAND),���ʽ��SCSIӲ�̵�Ӧ�ó��򣻢� SCSI��������װģ��(MOD��INSTALL),�Զ��ش������װģ��;�� SCSI���̰�װģ��(MOD��PROTO);�� SCSI�������򹫹�ǰ���ļ�ģ��(MOD��SYS);�� SCSI�������������Makefile�ļ�(MOD��MAKEFILE).
������SCSI���������м������е��ļ�������������ģ������.����������ģ������ģ�鼰�䲻ͬ�汾���й���,�汾�������������ģ��Ϊ��λ���е�.����Ա��Ϊ���ĵ���ǰ4��ģ��,����ģ��ֻ��Ϊ��֧���������������ı�����ṩ��.��������Ϊÿ��ģ�鶨����һ��ģ�������ļ���module��,�Ա���ģ���ڵ��ļ�����.�ļ�λ��COSIX���ְ汾SCSI���������Ŀ¼����Ӧģ����Ŀ¼��.
����������ģ������ܰ����Ӵ�����г��ָ��ģ���ָ���汾������ָ��ģ���ָ���汾�����С����������SCSI�����������ָ���汾������������SCSI�����������ָ���汾��������еĹ��ܡ��б���ʾĳһģ��汾��Ϣ���б���ʾ�����������������汾��Ϣ������ĳһ�汾Դ���.
��������Աһ�㲻��Ҫ�˽�*.module�ļ�,��Ϊ������Ϊ���ɵ��µ����俨���������Զ�����*.module�ļ�.����Ҫ����һ�����ļ���ĳһģ����,����Ҫ���﷨��ʽ�������ļ�.��������ļ��ȿ�������ͨ�ļ�,Ҳ������Ŀ¼��,��·��ǰ׺���������SCSI���汾���������Ŀ¼��.
2.2��SCSI���俨��������ģ������
��������������Ҫ�Ĺ������Զ�����SCSI���俨��������ģ��,����һ��������,�����ɳ���Ա����Ӳ���йصĲ���������Ӧ�ĺ�����.
�������磺modman-g unit_test ��The Test SCSI Card�� cosix,����cosixĿ¼�½���������testģ��,���ҽ�ģ�����cosix/scsi.in/ID/Makefile.cosix/scsi.in/io/Makefile��,�µ�testģ�齫��˳���ر��뵽����SCSI�����������.�������⣬���������޸�cosixĿ¼���йش��̡����̴��������ļ���ʹ�ó���Ա��������Ҫά����Щ�ļ��Ϳ������ɰ���unit_test���俨��������Ĵ��̡����̵����̰�װ��.����Ҫ����testģ���ڵ��ļ�,����Ա���Ա༭*.module�ļ�,��Ҫ������ļ���ڳ���β��,��������ļ���һ��Ŀ¼,��һ��Ҫ��֤������Ŀ¼�������ļ����ڴ�Ŀ¼��֮��.��������unit_test.c,unit_test.h�е�ĳЩ���ݽṹ�ͺ�����������һЩ����,��Щ����Ҳ�ǳ����Զ����ɵı�Ҫ����.�µ�unit_test.c�ǿ�����ȷ���벢������ĵ����俨����������,���д��ڳ���Ա��д�й�SCSI���俨Ӳ���Ĵ�����ܳ�Ϊ��ʵ�������SCSI���俨��������.
��������ԱҲ��ͨ����������modman-d modname directory�����俨��������ģ���SCSI��Ŀ¼��ɾȥ,���ɹ��߻��Զ�����Makefile,Shell����,ʹ֮�ָ����������俨��������֮ǰ��״̬.
2.3��SCSI����������Զ����
����COSIX���汾 SCSI���������Զ�������ܽ�����Makefile������.����Աֻ��򵥵ؼ���Makefile����Ӧ���,�Ϳ������ɴ��̡����̵����̰�װ��.
3 С����
����COSIX���ְ汾(COSIX V1.x ��COSIX V2.x)��SCSIϵͳ��������������������һ���ĵ��С���ơ����롢���Ժ�ʵ��Ӧ��,��1998��1��˳��ͨ���˹�����ع�����Ŀ�����������.����Ŀͻ����һϵ�м����ѹ�,SCSI��������������������������ɫ.Ͷ��ʵ��Ӧ���������������,��ϵͳ��������˿���Ч��,���Ҵ������˴������ȷ�ʼ����Ŷ�.��˵������Ŀʵ�������Ŀ��,��չ��COSIX��Ӧ������.
��ӱ���й���ѧԺ����о�����������100080����
���Σ��й���ѧԺ����о�����������100080����
���񷼣��й���ѧԺ����о�����������100080��
�ο�����
1��Ou-Yang Xing-hua. Computer system interface����SCSI. Beijing: Electronic Industry Press, 1995
(ŷ���˻�.�����ϵͳ�ӿڡ���SCSI.����:���ӹ�ҵ������,1995)
2��Liu Ri-sheng, Sun Yu-fang. The analyst report of the UNIX operating system. Computer Research and Development, 1982,19(9,10):1��115
(������,����.UNIX����ϵͳ��������.������о��뷢չ,1982,19(9,10):1��115)
3��PCI Special Interest Group. PCI LOCAL BUS SPECIFICATION Rev 2.1, USA Portland, 1995
4��AT��T UNIX system operation. UNIX System V/386 Release 4 Programmer Guide: SCSI Driver Interface. Englewood Cliffs, NJ: Prentice Hall, Inc., 1990
(ʷ����,�������.UNIXϵͳV/386��4�����Աָ�ϣ�SCSI�����������.����:���ӹ�ҵ������,1992)
5��Li Zhi-chen, Wang Ying. COSIX V1.x SCSI-like hard disk driver low level design specifications. Beijing: Open System �� Chinese Information Processing Center, Institute of Software, the Chinese Academy of Sciences, 1997
(��־��,��ӱ.Cosix V1.x SCSI��Ӳ������������ϸ���˵����.�������й���ѧԺ����о�������ϵͳ��������Ϣ��������,1997)
6��Jin Tao, He Jun. COSIX V2.x SCSI-like hard disk driver low level design specifications. Beijing: Open System �� Chinese Information Processing Center, Institute of Software, the Chinese Academy of Sciences, 1997
(����,�ξ�.Cosix V2.x SCSI��Ӳ������������ϸ˵����.�������й���ѧԺ����о�������ϵͳ��������Ϣ��������,1997)

��
