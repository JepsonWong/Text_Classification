微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
1999年 第18卷 第2期 Vol.18 No.2 1999



用微机载波实现实时抄表收费系统
何晓春
　　摘　要：介绍了1个实用的住宅区水、电、气实时收费系统，对其功能及实现进行了比较详细的描述。
　　关键词：实时收费　单片机　载波
　　随着我国城市建设的不断发展，城镇出现了各种住宅小区。尽管小区规划越来越科学，但是上门抄表及1月1次的水、电、气交费仍旧很麻烦。现在计算机和电子技术的高速发展，为实现实时收费系统奠定了基础。
1　系统功能及总体方案
　　1.总体方案
　　自动实时收费系统的框图如图1所示。

图1  系统原理框图
　　该系统利用输电线进行载波传送，每一用户家中采用1台8位单片机及外围电路进行数据采集、初步计算及数据传送，每一台小区变压器上由1台16位单片机进行数据汇编，并将处理后的数据传送至变配电站主机。在主机上可以完成各用户的水电气等费用的查询及交费工作，并能对各用户的用量进行实时监控。
　　从框图可以看出该系统采用了分布式计算机监测方案，由1台主机与多台16位单片机及用户家中的8位单片机组成3级分布式系统。主机及16位单片机考虑到工作环境是较强的电磁场，主要的工作是数据传送、采集及少量的运算，因此选用486工业机做主机，16位单片机选用Intel 8098。8位单片机主要是数据采集――采集经过数字化改造的水、煤、气模拟表(数字化改造可采用红外、电磁、机械等方式)的数值；初步计算――将采集的数值减去底数为当前消耗量；数据传送――定时将计算的结果编码后通过220V输电线载波传送至变压器低压侧。根据此要求及低成本限制，8位单片机选用8098单片机，配合EPROM以存储系统程序，EEPROM用于对采集的数据及计算的结果进行存储查询。16位单片机装在变压器上，将8位单片机定时载波传送至变压器低压侧的波形滤波整形后加以采集、计算、存储，在变压器高压测定时将数据编码后通过高压输电线载波传送至主机接口。主机安装在电控室，可以进入管理网络。各用户的电、水、气用量可以实时地反映在相应公司有关的计算机报表中。
　　2.系统功能
　　8位单片机主要完成数据采集、计算、存储及通信功能。
　　(1)数据采集、计算、存储功能：自动采集电能表、水表、煤气表脉冲信号并进行计算，得到当时的消耗量，将消耗量与该单片机的唯一号码组合起来存储在EEPROM中，等待上位机的通信信号。
　　(2)数据通信功能：在收到上位机(16位单片机)的通信信号后将存储的数据送至信号转换电路，将数字信号经光电隔离及信号耦合网络转换成220V载波信号，经输电线送到上位机通信口。
　　(3)由于用户电压不稳定且高频干扰较多，故增加1套看门狗电路，以防止应用程序跑飞。
　　16位单片机(简称节点机)主要完成1个变压器内所有8位单片机载波信号的接收、处理、转发功能。
　　(1)变压器低压侧载波信号的接收功能：由程序定时(如每小时1次)向每一个8位单片机发出通信信号，以便其将采集的数据发出。由于载波通信机接收的载波信号来自220V输电线，信号必须经信号耦合网络滤波后，经光电隔离再转换成单片机能处理的信号。考虑到该系统主要用在住宅小区，通信距离较近，故对二种单片机通信时的信号不作太高要求。
　　(2)编号处理、存储功能：单片机要完成对所有收集到的数据的编号工作，将各个8位单片机的信号(已含该机的编号码)处理后加上自身编号码及结束信号，经处理后将结果存储在存储芯片EEPROM中，等待上位机的通信信号，处于待发状态。
　　(3)数字信号的发送及载波处理功能：存储在芯片中的信息在收到上位机的许可信号后，经光电隔离及信号耦合网络转换成高压载波信号，通过载波通信机加在高压线路上，经长途传送后送至变、配电站主变压器低压侧。
　　主控机主要用于集中管理，其功能如下。
　　(1)变压器低压侧载波信号的接收、处理功能：由载波通信机接收的载波信号经信号耦合网络滤波后经光电隔离再转换成主机能处理的信号。考虑到主机与16位单片机(节点机)通信距离较远，设计2机通信时信号要求较高，故在通信时采取一些抗干扰及纠错功能，如重复发送至2次接收数据相同为止，加入抗干扰编码等。　　
　　(2)集中处理功能：在主机中主要是对整个数字系统进行集中控制、处理。①控制采集时间，对节点机的信号每隔一定时间采集1次，采集时通过载波线路依次向各节点机发出通信信号，激活节点机，使其存储在EEPROM中的待发信息发送至主机。②接收的信息经解码后将信息中的编号与相对应的各种消耗量送入主机相应的数据库中，对数据库中信息进行及时更新，并通过显示程序反映在主机屏幕上。③控制及报警功能：利用此实时收费系统可以及时了解各节点机至最终用户的消耗量。如某处消耗量超标，可向主机及该处节点机发出报警，通知工作人员适当减少负荷。如各节点机消耗总量与变配电站消耗总量不等，可知中途存在跑、冒、滴、漏或偷窃行为等。如电路发生短路，反映在消耗量上即出现异常，可实时发出报警信号并在主机网络上反映出故障点，以便于及时采取措施加以维护。
　　(3)主程序：主程序主要包括以下几项功能：定时通信功能、接收功能、发送功能、解码功能、编制修改数据库功能、显示功能、报警功能、异常情况处理功能。　　
2　软件框图
　　1.8位单片机程序框图如图2所示。 

图2  8位机程序框图
　　2.16位单片机框图如图3所示。

图3  16位机程序框图
　　3.主机框图如图4所示。

图4  主机程序框图
3　经济效益及社会效益
　　该系统采用了技术成熟、价廉物美的单片机硬件、高可靠性的工控机，系统性能稳定、实时性强，可节省大量的人力物力，彻底免除了上门抄表的工作，并可及时预报各种线路和人为故障，进行线路监测，并为以后进行自动控制留有充足的扩展余地。
作者单位：滁州市经贸委(239000)
(收稿日期：1998-09-04)
