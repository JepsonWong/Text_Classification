计算机应用研究
APPLICATION RESEARCH OF COMPUTERS
2000　Vol.17　No.2　P.82-83



基于SQL SERVER的POS系统的开发与实现
李涛　张艳珍　黎华　欧宗瑛
摘 要 介绍一个POS管理系统。文中首先介绍了POS终端的设计，然后介绍了服务器的设计，最后对该系统所采用的存储过程、触发器、报表输出、OPOS等关键技术进行了讨论。
关键词 数据库 POS 存储过程 触发器
1 系统概况
　　随着计算机软硬件的发展，POS(Point of sale)销售管理系统也不断发展。针对便民店、食品店等中小型商店的需要，我们采用数据库快速开发工具Visual Basic 5.0开发了基于WINDOWS NT WORKSTATION/ SERVER、SQL SERVER 6.5、OPOS(OLE POS)技术的POS系统。本POS系统包括POS终端、管理服务器。管理服务器可以连接条码打印机、手持扫描器、手持终端、页式打印机等设备。条码打印机可以打印商店内自己用的商品条码，手持扫描器用于在服务器端进行商品条码的扫描录入，手持终端用于在进行外卖时商品及收款信息的输入，页式打印机可用于打印各种报表。POS端的业务包括开闭店处理、通常销售、销售订正、打折销售、现金管理、各种结算等；服务器端的业务包括开闭店业务、销售管理、定货进货管理、付款管理、库存管理、顾客管理、收款管理以及系统基本管理。系统的结构如图1所示。

图1　POS管理系统
2 POS终端的设计
　　POS终端的功能主要有如下部分：
　　1)开店处理
　　营业员输入营业日期、准备的零钱信息、营业员信息及开店确认等。
　　2)销售业务
　　销售业务可以进行通常的销售，能进行商品信息的输入，如条码的读取、条码的手输入、商品的数量录入、商品部门代码的录入等，顾客结算及购物单的打印；销售业务还可以进行空容器的返还和销售的订正，如退货等。另外，在POS终端，还可以进行各种打折销售。
　　3)各种统计结算业务
　　输出POS的各种销售报表，如营业员销售实绩、部门的销售报告、商品的销售报告等。还可进行现金结算，检查现金有无缺少。
　　4)闭店处理
　　对当天的销售数据进行处理，输出所需要的报表。
　　5)系统管理业务
　　可以进行销售的练习、时刻的设定、营业员的变更、零钱的输入等。
3 服务器的功能设计
　　1)开闭店业务
　　在每天的营业开始时，服务器要首先开机并启动管理程序，输入当天的营业日期。在闭店处理时，对当天的销售数据、定货进货数据、付款数据、库存数据进行处理，生成相应的结算数据，并根据需要，选择输出相应的报表。如果当天是月度结算日期时，还要自动进行月度结算，将该当月度的销售、进货、付款、库存等数据结算成以月为单位的数据存入到数据库中，供下月的业务或月度报表使用，还根据选择打印商品、分类、部门的月度销售等报告。
　　2)销售管理业务
　　服务器在营业时，不断对POS终端传来的销售数据利用SQL SERVER的触发器进行实时处理，生成中间数据。这样，可以快速地查看当天的销售报表和掌握实际库存，还可以大大减少闭店处理所需的时间。经过闭店处理的销售数据和未作闭店处理的销售数据分别存放在结构相同但表名不同的表中，即分为历史销售数据、临时销售数据，闭店处理时只对临时销售数据进行处理，处理后将其全部转到销售历史数据。
　　对于大宗商品，利用条码扫描器可以在服务器上进行销售。可以赊帐销售，以后在服务器付款。如果赊帐销售，应登记顾客的信息，即要进行顾客管理，定期进行顾客的收款管理。
　　如果需要开展外卖业务，还可以利用手持终端，到顾客处销售。回到店里后将销售数据传输到数据库中以便进行管理。
　　3)定货和购进业务
　　定货业务让店长根据商品的库存情况或自己的预测进行商品的定货，可以输出定货书、商品的定货一览表、商品库存的最低值等报表。
　　购进业务可以对预定的货物进行进货，还可以对没有定货的商品进行进货。可以随时输出进货一览表。在进货后，要及时更新库存信息。
　　4)付款管理业务
　　付款管理要进行向供货商付款数据的录入和该当结帐日应向供货商付款额的计算，还要输出支付一览表、支付预定表、购货信息等报表。
　　5)库存及盘点管理业务
　　对于损坏或过期要废弃的商品要向计算机输入数量、金额等以更新商品的库存数据，便于正确地定货或购进。在商店进行商品盘点时将商品的实际数据输入数据库中，计算出实际库存。
　　6)顾客管理业务
　　顾客管理要进行顾客信息的登录，发行优惠卡等。
　　7)收款管理业务
　　收款管理要对赊帐购物的顾客进行收款管理，可以输入收款数据，输出以顾客为单位的赊帐信息、摧款书及其一览表、收款一览表等。
　　8)系统基本管理
　　为了便于对商品进行管理，商品要按部门、分类等进行分门别类。这就要输入商品的部门、分类数据。为了定货及购进，要输入供货商的数据，设定每个供货商的结帐日和付款方式。基本管理可以设定各种特卖，输入营业员数据。
4 关键技术研究
　　1)触发器的使用
　　所谓触发器，就是存储于数据库中的存储过程，它被绑定到一个指定的数据表上，在对该表中的数据进行指定操作后被自动激发，能够激发触发器的操作可以是插入、删除和数据更新三种。
　　在本系统中，为了能对POS终端传来的销售数据进行实时处理，我们利用了SQLSERVER 6.5的触发器。对于每条销售数据记录的插入，都将激发触发器，进行如下工作：如果数据库中无该种商品的销售统计数据，则生成该商品的销售统计数据，插入一条记录；如果有，则对其更新。这样，不用对所有商品每天都生成记录，大大减少数据库的数据量。对销售数据进行实时处理减少了闭店处理所需的时间。
　　在POS终端，对于各种销售数据，也利用了触发器对销售数据进行实时统计处理。
　　利用触发器进行实时处理，对于中小商店的业务量已经足够了，一台服务器可以带8台POS终端。但是，在服务器上进行如进货、新商品登录等其它业务时，对数据库中表的占用时间要尽可能地短，要极力避免造成死锁，影响实时处理，从而使前后台数据传输的停止。在我们的测试中，这种情况从来没有发生，证明了这种方案是可行的。原则上，触发器的处理时间要尽可能地短，不要进行太多的工作。
　　2)存储过程的使用
　　存储过程是由一些SQL语句和控制流语句组成的封装起来的过程，它们已编译通过且存储在数据库中，可以很快地执行。大型数据库一般都提供这种高效灵活的查询处理技术。存储过程可以返回包括状态在内的多个结果集。
　　为了提高POS终端和服务器闭店处理的速度，对于不需要进行人机交互的处理部分，我们采用了SQL SERVER的存储过程，而不是逐条地发SQL语句。在存储过程中，我们还利用了临时表生成临时数据，然后更新统计数据。在以月为单位的结算处理中，对所有的处理都采用了存储过程。
　　在报表的生成中，为了满足格式的需要和提高速度，我们也采用了存储过程。在输出报表时，先在数据库中，利用存储过程生成报表所需的临时表。然后通过报表控件输出。
　　3)RDO的使用
　　在Visual Basic 5.0中，访问SQL SERVER数据库有很多方式，如Data控件、Remote Data控件、ODBC API、数据访问对象DAO、远程数据对象RDO及VBSQL等。Data控件、RemoteData控件都很方便但不灵活。利用ODBC API访问数据库编程不方便。VB SQL是SQL SERVER为Visual Basic提供的访问数据库的最强大的访问工具，但是编程也不很方便，只在安装程序中建立应用程序的数据库时使用。RDO、DAO两种对象访问数据库都很方便灵活，RDO访问数据库的速度很快，在本系统中，我们采用了RDO。RDO通过SQL语句可以很方便地对数据库中的记录进行插入、更新、查询和删除。RDO除了可以通过发SQL语句取得需要的结果集外还可以执行存储过程。
　　在本系统中，POS终端、服务器都是通过RDO访问数据库。POS终端、服务器之间也采用RDO进行数据库间的通信。
　　4)各种报表的输出
　　在POS管理系统中，我们常常需要在后台服务器上输出各种报表。如果手工编程，则费时费力。为了满足需要，我们采用了水晶报表Crystal Reports、Formula One、First Impression等控件。水晶报表是Visual Basic 5.0自带的。水晶报表无需编程即可输出简单的报表。对于稍微复杂的报表可以利用存储过程，生成临时数据，然后利用水晶报表输出。Formula One、First Impression是由开发PowerBuilder的Sybase公司开发的ActiveX控件。Formula One、First Impression可供Visual Basic、Visual C++及Power Builder等使用。Formula One类似于EXCEL，但是有很大增强。利用Formula One可以很方便地在屏幕上和打印机上输出极其复杂的报表，完成报表所需要的换页功能。First Impression可以在屏幕上和打印机上输出相当复杂的图形报表。
　　5)OPOS技术
　　微软公司为了满足业界的需要，针对各个行业推出了一系列解决方案的标准。例如，针对零售业，提出了POS外围设备的OLE接口，供POS外围设备开发商和POS管理系统开发者参考使用。这样，不同厂商的POS外围设备可以互换而不必修改POS应用程序，极大提高了应用系统的可维护性。目前，OPOS设备标准已经有POS打印机、条码扫描器、POS键盘、钥匙锁、顾客显示器、钱箱抽屉等常用的设备。
　　对于POS管理系统开发者而言，使用OPOS设备如同使用ActiveX控件一样，非常方便。
5 结束语
　　目前，本系统已投放市场，正在根据用户的需要进行功能的强化。事实证明，我们所采用的平台及技术方案是正确的和有发展前途的。
　　本系统目前只适用单个商店，若稍加改造，增加总店的管理，可用于连锁店，还可增加同供货商的联网。如果需要，还可增加同应用系统的开发商或供货商联网，进行系统的远程维护。
李涛（大连理工大学机械系CAD研究所 大连 116024）
张艳珍（大连理工大学机械系CAD研究所 大连 116024）
黎华（大连理工大学机械系CAD研究所 大连 116024）
欧宗瑛（大连理工大学机械系CAD研究所 大连 116024）
参考文献
1，Transact-SQL Reference. Microsoft
2，Database Developer's Companion. Microsoft
3，Visual Basic Books Online. Microsoft
4，OLE for Retail POS-Application Programmer's Guide, Microsoft
5，石树刚, 郑振楣. 关系数据库. 北京: 清华大学出版社, 1993
收稿日期：1999年9月20日
